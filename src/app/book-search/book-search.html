<div class="book-search">
  <h2 class="pacifico-heading">Search Our BookNest</h2>
</div>

<form (submit)="$event.preventDefault()">

  <!-- SEARCH INPUT -->
  <input class="form-control d-inline w-25 border border-1 border-secondary"
         type="text"
         [placeholder]="disableLocationFilter ? 'Searching by title/author/series‚Ä¶' : 'Search for books'"
         [(ngModel)]="searchTerm"
         (input)="onSearchChange()"
         name="searchTerm"
         [disabled]="disableSearchBox" />

  <!-- SEARCH BUTTON -->
  <button class="btn btn-primary ms-1"
        type="button"
        [disabled]="!searchTerm && !selectedLocation"
        (click)="isSearching ? resetFilters() : applyFilters()">
        {{ isSearching ? 'Reset for new Search' : 'Search' }}
  </button>

  <div class="inline-float-right d-flex align-items-center">

  <!-- FILTER BUTTON -->
  <button class="btn btn-primary me-2"
          type="button"
          [disabled]="!selectedLocation"
          (click)="isSearching ? resetFilters() : applyFilters()">
    {{ isSearching && selectedLocation ? 'Reset for New Filter' : 'Filter' }}
  </button>

    <!-- LOCATION FILTER -->
    <select class="form-select w-auto border-secondary"
            [(ngModel)]="selectedLocation"
            (change)="onLocationChange()"
            name="locationFilter"
            [disabled]="disableLocationFilter"
            aria-label="Filter books by location">
      <option value="">All Locations</option>
      @for (loc of allLocations; track loc) {
        <option [value]="loc">
          {{ loc }}
        </option>
      }
    </select>

  </div>
</form>

<br>

<section class="results">

@if (fullResults.length === 0) {
  <div class="empty-state">
    <div class="empty-icon">‚ú®</div>
    <p>No books match your search yet.</p>

    @if (isSearching) {
      <p class="empty-hint">
        Try adjusting your search or location filter.
      </p>
    } @else {
      <p class="empty-subtext">
        Your BookNest is empty. Start by adding your first book!
      </p>
      <a class="btn btn-details mt-2" routerLink="/books/new">
        Add a Book
      </a>
    }
  </div>
}
@if (fullResults.length > 0) {
  <table class="table table-hover table-striped table-bordered">
    <thead>
      <tr>
        <th>
          <div class="sort-container">
            <span>Title</span>
            <button class="sort-arrow"
                    (click)="sortByDirection('title', 'asc')"
                    aria-label="Sort title ascending">
              <i class="bi bi-caret-up-fill"
                 [class.active]="sortColumn === 'title' && sortDirection === 'asc'"></i>
            </button>
            <button class="sort-arrow"
                    (click)="sortByDirection('title', 'desc')"
                    aria-label="Sort title descending">
              <i class="bi bi-caret-down-fill"
                 [class.active]="sortColumn === 'title' && sortDirection === 'desc'"></i>
            </button>
          </div>
        </th>

        <th>
          <div class="sort-container">
            <span>Author Last</span>
            <button class="sort-arrow"
                    (click)="sortByDirection('author_last_name', 'asc')"
                    aria-label="Sort author_last_name ascending">
              <i class="bi bi-caret-up-fill"
                 [class.active]="sortColumn === 'author_last_name' && sortDirection === 'asc'"></i>
            </button>
            <button class="sort-arrow"
                    (click)="sortByDirection('author_last_name', 'desc')"
                    aria-label="Sort author_last_name descending">
              <i class="bi bi-caret-down-fill"
                 [class.active]="sortColumn === 'author_last_name' && sortDirection === 'desc'"></i>
            </button>
          </div>
        </th>

        <th>
          <div class="sort-container">
            <span>Author First</span>
            <button class="sort-arrow"
                    (click)="sortByDirection('author_first_name', 'asc')"
                    aria-label="Sort author_first_name ascending">
              <i class="bi bi-caret-up-fill"
                 [class.active]="sortColumn === 'author_first_name' && sortDirection === 'asc'"></i>
            </button>
            <button class="sort-arrow"
                    (click)="sortByDirection('author_first_name', 'desc')"
                    aria-label="Sort author_first_name descending">
              <i class="bi bi-caret-down-fill"
                 [class.active]="sortColumn === 'author_first_name' && sortDirection === 'desc'"></i>
            </button>
          </div>
        </th>

        <th>
          <div class="sort-container">
            <span>Series</span>
            <button class="sort-arrow"
                    (click)="sortByDirection('series_name', 'asc')"
                    aria-label="Sort series_name ascending">
              <i class="bi bi-caret-up-fill"
                 [class.active]="sortColumn === 'series_name' && sortDirection === 'asc'"></i>
            </button>
            <button class="sort-arrow"
                    (click)="sortByDirection('series_name', 'desc')"
                    aria-label="Sort series_name descending">
              <i class="bi bi-caret-down-fill"
                 [class.active]="sortColumn === 'series_name' && sortDirection === 'desc'"></i>
            </button>
          </div>
        </th>

        <th>Details</th>
      </tr>
    </thead>

    <tbody>
      @for (result of pagedResults; track result.id) {
      <tr>
        <td class="position-relative">
         <span class="book-title">
        {{ result.title.length > 38
          ? (result.title | slice:0:38) + '...'
          : result.title
        }}
        </span>

        @if (result.isPotentialDuplicate) {
          <span class="duplicate-badge ms-2">
            üëÄ Looks Familiar
          </span>
        }
        </td>
        <td>{{ result.author_last_name !== 'NA' ? result.author_last_name : '' }}</td>
        <td>{{ result.author_first_name !== 'NA' ? result.author_first_name : '' }}</td>
        <td> {{
          (result.series_name || '').length > 30
          ? ((result.series_name || '') | slice:0:30) + '...'
          : (result.series_name || '')
          }}
        </td>
        <td class="text-center">
          <a [routerLink]="['/books', result.id]" [queryParamsHandling]="'preserve'" class="icon-link">
            üîç
          </a>
        </td>
      </tr>
      }
    </tbody>
  </table>
}
  <div class="d-flex justify-content-center mt-3">
    <button (click)="previousPage()"
            class="btn btn-secondary me-5"
            id="previous"
            [disabled]="previousDisabled">
      Previous
    </button>

    <span class="results-counter">
      {{ resultsCounter }}
    </span>

    <button (click)="nextPage()"
            class="btn btn-secondary ms-5"
            id="next"
            [disabled]="nextDisabled">
      Next
    </button>
  </div>

</section>

